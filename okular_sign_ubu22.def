Bootstrap: docker
From: ubuntu:22.04

%post

apt-get update
apt-get -y upgrade
apt-get -y install locales
locale-gen en_US.UTF-8 de_DE.UTF-8

DEBIAN_FRONTEND=noninteractive apt-get -y install \
    cmake extra-cmake-modules g++ gettext git kirigami2-dev libboost-container-dev \
    libcairo2-dev libchm-dev libcurl4-nss-dev libdjvulibre-dev libepub-dev \
    libfontconfig1-dev libfreetype6-dev \
    libkf5activities-dev libkf5archive-dev libkf5bookmarks-dev libkf5completion-dev \
    libkf5config-dev libkf5coreaddons-dev libkf5crash-dev libkf5dbusaddons-dev \
    libkf5doctools-dev libkf5i18n-dev libkf5kexiv2-dev libkf5khtml-dev libkf5kio-dev \
    libkf5kjs-dev libkf5notifications-dev libkf5parts-dev libkf5pty-dev libkf5purpose-dev \
    libkf5threadweaver-dev libkf5wallet-dev \
    liblcms2-dev libnss3-dev libopenjp2-7-dev libopenjpip-dec-server libphonon4qt5-dev \
    libpng-dev libpng++-dev libqmobipocket-dev libqt5svg5-dev libqt5texttospeech5-dev \
    libspectre-dev libtiff5-dev libzip-dev pkg-config qtbase5-dev qtdeclarative5-dev

PREFIX=/opt

BUILD_DIR="$(mktemp -d)"

# apparently needed for boost when building inside the container
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin":$PATH


## build poppler

cd "$BUILD_DIR"

git clone https://gitlab.freedesktop.org/poppler/poppler.git
cd poppler

mkdir build
cd build
cmake -DCMAKE_INSTALL_PREFIX="$PREFIX" -DCMAKE_BUILD_TYPE=Release ..

make -j$(nproc)
make install

## make okular

cd "$BUILD_DIR"

git clone -b v22.04.1 https://invent.kde.org/graphics/okular.git
cd okular

mkdir build
cd build
cmake -DCMAKE_INSTALL_PREFIX="$PREFIX" -DCMAKE_PREFIX_PATH="$PREFIX" -DCMAKE_BUILD_TYPE=Release ..
make -j$(nproc)
make install


%runscript

TZ=/usr/share/zoneinfo/Europe/Berlin QT_PLUGIN_PATH=/opt/lib/x86_64-linux-gnu/plugins XDG_DATA_DIRS=/opt/share LD_LIBRARY_PATH=/opt/lib:/opt/lib/x86_64-linux-gnu/plugins:/opt/lib/x86_64-linux-gnu/plugins/okular:/opt/lib/x86_64-linux-gnu/plugins/okular/generators /opt/bin/okular "$@"


%test
if command -v /opt/bin/okular &>/dev/null; then echo 'Okular is there.'; exit 0
else echo 'The okular command is missing!'; exit 1; fi



